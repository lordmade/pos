<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bophelo Bot | AI Health Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>
    
    <style>
        :root { 
            --medical-emerald: #10b981; 
            --sa-gold: #FFB612; 
            --sa-green: #007749; 
            --sa-red: #DE3831; 
            --sa-blue: #002395; 
            --bg-dark: #0F172A;
            --bg-card: #1E293B;
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --border-color: #334155;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); } }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            position: relative;
            background: var(--bg-dark);
        }

        /* Header */
        .app-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            z-index: 100;
        }

        .brand-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--medical-emerald), var(--sa-green));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            animation: pulse-glow 2s infinite;
        }

        .brand-text h1 {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .brand-text p {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lang-selector {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .lang-btn {
            padding: 4px 10px;
            border-radius: 16px;
            border: none;
            background: transparent;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background: var(--medical-emerald);
            color: white;
        }

        .user-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-btn:hover {
            border-color: var(--medical-emerald);
            color: var(--medical-emerald);
        }

        /* Emergency Banner */
        .emergency-banner {
            background: linear-gradient(90deg, rgba(222, 56, 49, 0.1), rgba(222, 56, 49, 0.05));
            border-bottom: 1px solid rgba(222, 56, 49, 0.2);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.75rem;
            color: #FCA5A5;
            font-weight: 500;
        }

        .emergency-banner .material-symbols-rounded {
            font-size: 16px;
            color: var(--sa-red);
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            text-align: center;
            padding: 40px 20px;
            animation: fadeIn 0.6s ease;
        }

        .welcome-icon-large {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--medical-emerald), var(--sa-green));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 24px;
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.2);
        }

        .welcome-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--text-primary), var(--medical-emerald));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            max-width: 400px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }

        .suggestion-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .suggestion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--medical-emerald), transparent);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .suggestion-card:hover {
            transform: translateY(-2px);
            border-color: var(--medical-emerald);
            background: #252f47;
        }

        .suggestion-card:hover::before {
            transform: scaleX(1);
        }

        .suggestion-icon {
            color: var(--medical-emerald);
            margin-bottom: 12px;
        }

        .suggestion-card h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .suggestion-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 12px;
            max-width: 85%;
            animation: fadeIn 0.4s ease;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, var(--medical-emerald), var(--sa-green));
            color: white;
        }

        .message.user .message-avatar {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .message.ai .message-bubble {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
        }

        .message.user .message-bubble {
            background: var(--medical-emerald);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .message.user .message-meta {
            justify-content: flex-end;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--medical-emerald);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Critical Alert */
        .critical-alert {
            background: rgba(222, 56, 49, 0.1);
            border: 1px solid rgba(222, 56, 49, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
        }

        .critical-alert h3 {
            color: #FCA5A5;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .critical-alert p {
            color: #FCA5A5;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Input Area */
        .input-container {
            padding: 16px 20px 20px;
            background: var(--bg-dark);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--bg-card);
            padding: 8px 8px 8px 16px;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .input-wrapper:focus-within {
            border-color: var(--medical-emerald);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 0;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--text-primary);
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 24px;
        }

        .chat-input::placeholder { color: var(--text-secondary); }
        .chat-input:disabled { opacity: 0.5; cursor: not-allowed; }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--medical-emerald);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            background: #059669;
            transform: scale(1.05);
        }

        .send-btn:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
            background: var(--border-color);
        }

        .disclaimer {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .auth-modal {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-color);
            animation: slideUp 0.4s ease;
        }

        .auth-modal .brand-icon {
            margin: 0 auto 24px;
            width: 64px;
            height: 64px;
            animation: none;
        }

        .auth-modal h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .auth-modal p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 0.9rem;
        }

        .google-btn {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            background: var(--bg-dark);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-family: inherit;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .google-btn:hover {
            border-color: var(--medical-emerald);
            background: rgba(16, 185, 129, 0.1);
        }

        /* Mobile Optimizations */
        @media (max-width: 640px) {
            .app-header { padding: 12px 16px; }
            .messages-area { padding: 16px; }
            .input-container { padding: 12px 16px 16px; }
            .welcome-title { font-size: 1.5rem; }
            .suggestions-grid { grid-template-columns: 1fr; }
            .message { max-width: 90%; }
            .emergency-banner { font-size: 0.7rem; padding: 8px 12px; }
            .lang-selector { display: none; }
        }

        @media (min-width: 768px) {
            .app-container {
                border-left: 1px solid var(--border-color);
                border-right: 1px solid var(--border-color);
            }
        }

        .mono { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="flex items-center gap-3">
                <div class="brand-icon">
                    <span class="material-symbols-rounded text-xl">local_hospital</span>
                </div>
                <div class="brand-text">
                    <h1>BOPHELO BOT</h1>
                    <p>AI Health Assistant • South Africa</p>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="lang-selector">
                    <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
                    <button class="lang-btn" onclick="setLanguage('zu')">ZU</button>
                    <button class="lang-btn" onclick="setLanguage('af')">AF</button>
                </div>
                
                <button onclick="toggleAuth()" id="userBtn" class="user-btn">
                    <span class="material-symbols-rounded text-lg">person</span>
                </button>
            </div>
        </div>

        <!-- Emergency Banner -->
        <div class="emergency-banner">
            <span class="material-symbols-rounded">emergency</span>
            <span>Emergency: <strong>10177</strong> (Ambulance) • <strong>082 911</strong> (Netcare)</span>
        </div>

        <!-- Messages Area -->
        <div class="messages-area" id="messagesArea">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon-large">
                    <span class="material-symbols-rounded text-4xl">stethoscope</span>
                </div>
                <h2 class="welcome-title">Your Health Companion</h2>
                <p class="welcome-subtitle">Ask about symptoms, medications, or local healthcare services. Available in English, isiZulu, and Afrikaans.</p>
                
                <div class="suggestions-grid">
                    <div class="suggestion-card" onclick="setInput('I have a headache and fever, what could it be?')">
                        <div class="suggestion-icon">
                            <span class="material-symbols-rounded text-2xl">sick</span>
                        </div>
                        <h4>Check Symptoms</h4>
                        <p>Headache, fever, flu, or general illness guidance</p>
                    </div>
                    
                    <div class="suggestion-card" onclick="setInput('What are the warning signs of a heart attack?')">
                        <div class="suggestion-icon">
                            <span class="material-symbols-rounded text-2xl">cardiology</span>
                        </div>
                        <h4>Emergency Signs</h4>
                        <p>When to call emergency services immediately</p>
                    </div>
                    
                    <div class="suggestion-card" onclick="setInput('How do I manage high blood pressure?')">
                        <div class="suggestion-icon">
                            <span class="material-symbols-rounded text-2xl">monitor_heart</span>
                        </div>
                        <h4>Chronic Care</h4>
                        <p>Hypertension, diabetes, and HIV management</p>
                    </div>
                    
                    <div class="suggestion-card" onclick="setInput('Where can I get ARVs near me?')">
                        <div class="suggestion-icon">
                            <span class="material-symbols-rounded text-2xl">local_hospital</span>
                        </div>
                        <h4>Local Resources</h4>
                        <p>Clinics, hospitals, and medication access</p>
                    </div>
                </div>
                
                <div class="mt-8 flex items-center gap-2 text-xs text-slate-500 mono">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    Neural Core v4.0.2 • xAI Powered
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="userInput" 
                    placeholder="Describe your symptoms or ask a health question..." 
                    rows="1"
                    disabled
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                    <span class="material-symbols-rounded">arrow_upward</span>
                </button>
            </div>
            <div class="disclaimer">
                Bophelo Bot is not a substitute for professional medical advice
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="auth-modal">
            <div class="brand-icon">
                <span class="material-symbols-rounded text-3xl">local_hospital</span>
            </div>
            <h2>Welcome to Bophelo Bot</h2>
            <p>Sign in to access personalized health assistance</p>
            <button class="google-btn" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <script>
        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            projectId: "fire-b-a8878",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const remoteConfig = firebase.remoteConfig();
        
        let XAI_API_KEY = "";
        const MODEL_ID = "grok-4-1-fast-reasoning";
        
        let currentUser = null;
        let isProcessing = false;
        let conversationHistory = [];
        let currentLanguage = 'en';
        
        const SA_EMERGENCY = {
            ambulance: '10177',
            netcare: '082 911',
            er24: '084 124',
            poison: '0861 555 777'
        };
        
        // Initialize
        async function initializeApp() {
            remoteConfig.settings = { minimumFetchIntervalMillis: 0 };
            try {
                await remoteConfig.fetchAndActivate();
                XAI_API_KEY = remoteConfig.getValue('xai_api_key').asString();
            } catch (error) {
                console.error('Remote Config error:', error);
                XAI_API_KEY = "your-xai-api-key-here";
            }
        }
        
        // Auth
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUI(user);
            
            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            
            input.disabled = !user;
            sendBtn.disabled = !user;
        });
        
        function updateUI(user) {
            const userBtn = document.getElementById('userBtn');
            if (user) {
                userBtn.innerHTML = `<span class="font-bold text-emerald-500 text-sm">${user.displayName?.[0] || 'U'}</span>`;
                document.getElementById('authModal').classList.remove('active');
            } else {
                userBtn.innerHTML = `<span class="material-symbols-rounded text-lg">person</span>`;
            }
        }
        
        function toggleAuth() {
            if (!currentUser) {
                document.getElementById('authModal').classList.add('active');
            } else {
                if (confirm('Sign out of Bophelo Bot?')) {
                    auth.signOut();
                    conversationHistory = [];
                    resetChat();
                }
            }
        }
        
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error('Auth error:', error);
                alert('Sign in failed. Please try again.');
            });
        }
        
        // Language
        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const placeholders = {
                en: "Describe your symptoms or ask a health question...",
                zu: "Chaza izimpawu zakho noma ubuze umbuzo wezempilo...",
                af: "Beskryf jou simptome of vra 'n gesondheidsvraag..."
            };
            
            document.getElementById('userInput').placeholder = placeholders[lang];
        }
        
        // Chat Functions
        function setInput(text) {
            if (!currentUser) {
                toggleAuth();
                return;
            }
            const input = document.getElementById('userInput');
            input.value = text;
            input.focus();
            autoResize(input);
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        function resetChat() {
            conversationHistory = [];
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = `
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon-large">
                        <span class="material-symbols-rounded text-4xl">stethoscope</span>
                    </div>
                    <h2 class="welcome-title">Your Health Companion</h2>
                    <p class="welcome-subtitle">Ask about symptoms, medications, or local healthcare services. Available in English, isiZulu, and Afrikaans.</p>
                    
                    <div class="suggestions-grid">
                        <div class="suggestion-card" onclick="setInput('I have a headache and fever, what could it be?')">
                            <div class="suggestion-icon">
                                <span class="material-symbols-rounded text-2xl">sick</span>
                            </div>
                            <h4>Check Symptoms</h4>
                            <p>Headache, fever, flu, or general illness guidance</p>
                        </div>
                        
                        <div class="suggestion-card" onclick="setInput('What are the warning signs of a heart attack?')">
                            <div class="suggestion-icon">
                                <span class="material-symbols-rounded text-2xl">cardiology</span>
                            </div>
                            <h4>Emergency Signs</h4>
                            <p>When to call emergency services immediately</p>
                        </div>
                        
                        <div class="suggestion-card" onclick="setInput('How do I manage high blood pressure?')">
                            <div class="suggestion-icon">
                                <span class="material-symbols-rounded text-2xl">monitor_heart</span>
                            </div>
                            <h4>Chronic Care</h4>
                            <p>Hypertension, diabetes, and HIV management</p>
                        </div>
                        
                        <div class="suggestion-card" onclick="setInput('Where can I get ARVs near me?')">
                            <div class="suggestion-icon">
                                <span class="material-symbols-rounded text-2xl">local_hospital</span>
                            </div>
                            <h4>Local Resources</h4>
                            <p>Clinics, hospitals, and medication access</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex items-center gap-2 text-xs text-slate-500 mono">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        Neural Core v4.0.2 • xAI Powered
                    </div>
                </div>
            `;
            document.getElementById('userInput').value = '';
        }
        
        async function sendMessage() {
            if (isProcessing || !currentUser) return;
            
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            isProcessing = true;
            input.value = '';
            autoResize(input);
            
            const welcome = document.getElementById('welcomeScreen');
            if (welcome) welcome.remove();
            
            // Emergency detection
            const emergencyKeywords = [
                'chest pain', 'heart attack', 'stroke', 'can\'t breathe', 'not breathing', 
                'unconscious', 'severe bleeding', 'suicide', 'kill myself', 'choking',
                'isifuba', 'ngingafa', 'struggling to breathe', 'hartaanval',
                'breyting', 'bewusteloos', 'ernstige bloeding'
            ];
            
            const isEmergency = emergencyKeywords.some(keyword => 
                message.toLowerCase().includes(keyword)
            );
            
            addMessage('user', message);
            
            if (isEmergency) {
                const emergencyHTML = `
                    <div class="critical-alert">
                        <h3>
                            <span class="material-symbols-rounded text-lg">emergency</span>
                            MEDICAL EMERGENCY DETECTED
                        </h3>
                        <p><strong>Call emergency services immediately:</strong></p>
                        <p class="mt-2">• <strong>Netcare 911:</strong> ${SA_EMERGENCY.netcare}<br>
                        • <strong>ER24:</strong> ${SA_EMERGENCY.er24}<br>
                        • <strong>Ambulance:</strong> ${SA_EMERGENCY.ambulance}</p>
                        <p class="mt-2">Do not wait for AI assistance. If you cannot call, ask someone nearby to call for you.</p>
                    </div>
                `;
                addMessage('ai', emergencyHTML);
                isProcessing = false;
                return;
            }
            
            const typingId = showTyping();
            
            try {
                const response = await fetchXAIResponse(message);
                removeTyping(typingId);
                addMessage('ai', response);
                
                conversationHistory.push({ role: 'user', content: message });
                conversationHistory.push({ role: 'assistant', content: response });
                
            } catch (error) {
                removeTyping(typingId);
                addMessage('ai', 'I apologize, but I encountered an error. Please try again or contact your healthcare provider directly.');
                console.error('xAI Error:', error);
            }
            
            isProcessing = false;
        }
        
        async function fetchXAIResponse(message) {
            const systemPrompt = `You are Bophelo Bot, a helpful medical information assistant for South Africa. 

CRITICAL GUIDELINES:
1. Always include a disclaimer that you are an AI, not a doctor
2. For serious symptoms, urge users to seek professional medical care immediately
3. Never provide definitive diagnoses - only general health information
4. Be empathetic, clear, and culturally sensitive to South African context
5. Reference local resources where appropriate (public clinics, Netcare, ER24, HIV testing sites)
6. If unsure, recommend consulting a healthcare provider at a local clinic or hospital
7. Never prescribe medications or specific dosages
8. Support multiple South African languages and contexts
9. Always prioritize safety over completeness

Emergency numbers in South Africa:
- Netcare 911: 082 911
- ER24: 084 124  
- Ambulance: 10177
- Poison Control: 0861 555 777

Current date: ${new Date().toISOString().split('T')[0]}`;
            
            const messages = [
                { role: "system", content: systemPrompt },
                ...conversationHistory.slice(-10).map(msg => ({
                    role: msg.role === 'assistant' ? 'assistant' : 'user',
                    content: msg.content
                })),
                { role: "user", content: message }
            ];
            
            const response = await fetch("https://api.x.ai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${XAI_API_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: MODEL_ID,
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 800,
                    stream: false
                })
            });
            
            if (!response.ok) throw new Error('API request failed');
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        function addMessage(role, content) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const time = new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
            const isHTML = content.includes('<div');
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${role === 'ai' ? 'BB' : currentUser?.displayName?.[0] || 'U'}
                </div>
                <div class="message-content">
                    <div class="message-bubble">${isHTML ? content : formatContent(content)}</div>
                    <div class="message-meta">
                        ${role === 'ai' ? '<span class="material-symbols-rounded text-xs">verified</span> Bophelo Bot • ' : ''}
                        ${time}
                    </div>
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        function formatContent(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-emerald-400">$1</strong>')
                .replace(/\n/g, '<br>');
        }
        
        function showTyping() {
            const messagesArea = document.getElementById('messagesArea');
            const id = 'typing-' + Date.now();
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = id;
            typingDiv.innerHTML = `
                <div class="message-avatar">BB</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            messagesArea.appendChild(typingDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            return id;
        }
        
        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
        
        // Event Listeners
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('userInput').addEventListener('input', function() {
            autoResize(this);
        });
        
        // Initialize
        initializeApp();
    </script>
</body>
</html>
