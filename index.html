<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bophelo Bot | AI Health Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>
    
    <style>
        :root { --medical-emerald: #10b981; --sa-gold: #FFB612; --sa-green: #007749; --sa-red: #DE3831; --sa-blue: #002395; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC;
            color: #0F172A;
            overflow: hidden;
            background-image: radial-gradient(#E2E8F0 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        /* Animated Background Elements */
        .hex-grid {
            position: fixed;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%2310b981' fill-opacity='0.03'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-8l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            animation: hex-drift 60s linear infinite;
            z-index: -2;
            pointer-events: none;
        }
        
        @keyframes hex-drift {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50px); }
        }
        
        .pulse-ring {
            position: fixed;
            border: 2px solid rgba(16, 185, 129, 0.1);
            border-radius: 50%;
            animation: heartbeat 4s ease-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes heartbeat {
            0% { transform: scale(0.8); opacity: 0.8; }
            50% { opacity: 0.3; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        /* Glassmorphism Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-8px);
            border-color: var(--medical-emerald);
            box-shadow: 0 40px 80px -15px rgba(16, 185, 129, 0.15);
        }
        
        /* Chat Interface */
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(226, 232, 240, 0.8);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user { flex-direction: row-reverse; }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .message.ai .message-avatar {
            background: linear-gradient(135deg, var(--medical-emerald), #059669);
            color: white;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--sa-blue), var(--sa-green));
            color: white;
        }
        
        .message-content {
            flex: 1;
            max-width: 80%;
        }
        
        .message-bubble {
            padding: 16px 20px;
            border-radius: 20px;
            line-height: 1.6;
            font-size: 0.95rem;
            word-wrap: break-word;
        }
        
        .message.ai .message-bubble {
            background: white;
            color: #0F172A;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--medical-emerald), #059669);
            color: white;
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }
        
        .message-meta {
            font-size: 0.75rem;
            color: #64748B;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .message.user .message-meta { justify-content: flex-end; color: #94A3B8; }
        
        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: #F1F5F9;
            padding: 8px;
            border-radius: 24px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s ease;
        }
        
        .input-wrapper:focus-within {
            background: white;
            border-color: var(--medical-emerald);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 16px;
            font-family: inherit;
            font-size: 0.95rem;
            color: #0F172A;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 24px;
        }
        
        .chat-input::placeholder { color: #94A3B8; }
        .chat-input:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--medical-emerald);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .send-btn:hover:not(:disabled) {
            background: #059669;
            transform: scale(1.05);
        }
        
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #94A3B8; }
        
        /* Emergency Banner */
        .emergency-banner {
            background: linear-gradient(90deg, var(--sa-red), #B91C1C);
            color: white;
            padding: 12px 24px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .emergency-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Header */
        .app-header {
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--medical-emerald), var(--sa-green));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }
        
        .brand-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0F172A;
            letter-spacing: -0.02em;
        }
        
        .brand-text p {
            font-size: 0.75rem;
            color: #64748B;
            font-weight: 500;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--medical-emerald);
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            text-align: center;
        }
        
        .welcome-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--medical-emerald), var(--sa-green));
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 32px;
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.2);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .welcome-screen h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #0F172A;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }
        
        .welcome-screen > p {
            color: #64748B;
            max-width: 500px;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        /* Suggestion Cards */
        .suggestions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }
        
        .suggestion-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(226, 232, 240, 0.8);
            position: relative;
            overflow: hidden;
        }
        
        .suggestion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--medical-emerald);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .suggestion-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
            border-color: var(--medical-emerald);
        }
        
        .suggestion-card:hover::before {
            transform: scaleY(1);
        }
        
        .suggestion-card h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #0F172A;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .suggestion-card p {
            font-size: 0.8rem;
            color: #64748B;
            margin: 0;
        }
        
        .suggestion-icon {
            color: var(--medical-emerald);
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 20px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--medical-emerald);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        /* Critical Warning */
        .critical-alert {
            background: linear-gradient(135deg, #FEF2F2, #FEE2E2);
            border: 2px solid var(--sa-red);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            position: relative;
            overflow: hidden;
        }
        
        .critical-alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--sa-red);
            animation: alert-pulse 2s infinite;
        }
        
        @keyframes alert-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .critical-alert h3 {
            color: var(--sa-red);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .critical-alert p {
            color: #7F1D1D;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .auth-modal {
            background: white;
            padding: 40px;
            border-radius: 24px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modal-in 0.4s ease;
        }
        
        @keyframes modal-in {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .auth-modal .brand-icon {
            margin: 0 auto 24px;
            width: 64px;
            height: 64px;
        }
        
        .auth-modal h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0F172A;
            margin-bottom: 8px;
        }
        
        .auth-modal p {
            color: #64748B;
            margin-bottom: 32px;
            font-size: 0.95rem;
        }
        
        .google-btn {
            width: 100%;
            padding: 14px;
            border: 2px solid #E2E8F0;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .google-btn:hover {
            border-color: var(--medical-emerald);
            background: #F0FDF4;
        }
        
        /* Language Selector */
        .lang-selector {
            position: absolute;
            top: 20px;
            right: 24px;
            display: flex;
            gap: 8px;
        }
        
        .lang-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #E2E8F0;
            background: white;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .lang-btn.active {
            background: var(--medical-emerald);
            color: white;
            border-color: var(--medical-emerald);
        }
        
        /* Scrollbar */
        .messages-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-area::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .messages-area::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 4px;
        }
        
        .messages-area::-webkit-scrollbar-thumb:hover {
            background: #94A3B8;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .chat-container { border: none; }
            .suggestions { grid-template-columns: 1fr; }
            .message-content { max-width: 90%; }
            .welcome-screen h2 { font-size: 1.5rem; }
        }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="hex-grid"></div>
    <div class="pulse-ring" style="width: 200px; height: 200px; top: 10%; left: 10%;"></div>
    <div class="pulse-ring" style="width: 300px; height: 300px; top: 60%; right: 15%; animation-delay: 1.3s;"></div>
    
    <!-- Emergency Banner -->
    <div class="emergency-banner">
        <span class="material-symbols-rounded">emergency</span>
        <span>Medical emergency? Call <strong>10177</strong> (Ambulance) or <strong>082 911</strong> (Netcare) | This AI does not replace professional care</span>
    </div>
    
    <div class="chat-container">
        <!-- Header -->
        <div class="app-header">
            <div class="brand">
                <div class="brand-icon">
                    <span class="material-symbols-rounded">local_hospital</span>
                </div>
                <div class="brand-text">
                    <h1>BOPHELO BOT</h1>
                    <p>AI Health Assistant • South Africa</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="lang-selector">
                    <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
                    <button class="lang-btn" onclick="setLanguage('zu')">ZU</button>
                    <button class="lang-btn" onclick="setLanguage('af')">AF</button>
                </div>
                
                <div class="status-badge">
                    <span class="status-dot"></span>
                    <span>System Online</span>
                </div>
                
                <button onclick="toggleAuth()" id="userBtn" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition">
                    <span class="material-symbols-rounded text-slate-600">person</span>
                </button>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div class="messages-area flex-1 overflow-y-auto p-6" id="messagesArea">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon">
                    <span class="material-symbols-rounded" style="font-size: 48px;">stethoscope</span>
                </div>
                <h2>Your Personal Health Assistant</h2>
                <p>Describe your symptoms or health concerns in English, isiZulu, or Afrikaans. I'll provide general health information tailored for South Africa.</p>
                
                <div class="suggestions">
                    <div class="suggestion-card" onclick="setInput('I have a headache and fever, what could it be?')">
                        <h4>
                            <span class="material-symbols-rounded suggestion-icon" style="font-size: 20px;">sick</span>
                            Symptom Checker
                        </h4>
                        <p>Headache, fever, flu symptoms</p>
                    </div>
                    <div class="suggestion-card" onclick="setInput('What are the warning signs of a heart attack?')">
                        <h4>
                            <span class="material-symbols-rounded suggestion-icon" style="font-size: 20px;">cardiology</span>
                            Emergency Signs
                        </h4>
                        <p>When to call 10177 immediately</p>
                    </div>
                    <div class="suggestion-card" onclick="setInput('How do I manage high blood pressure?')">
                        <h4>
                            <span class="material-symbols-rounded suggestion-icon" style="font-size: 20px;">monitor_heart</span>
                            Chronic Conditions
                        </h4>
                        <p>Hypertension, diabetes, HIV management</p>
                    </div>
                    <div class="suggestion-card" onclick="setInput('Where can I get ARVs near me?')">
                        <h4>
                            <span class="material-symbols-rounded suggestion-icon" style="font-size: 20px;">local_hospital</span>
                            Local Healthcare
                        </h4>
                        <p>Clinics, hospitals, medication access</p>
                    </div>
                </div>
                
                <div class="mt-8 flex items-center gap-2 text-xs text-slate-400 mono">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    Neural Core v4.0.2 • xAI Powered
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="input-area">
            <div class="input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="userInput" 
                    placeholder="Describe your symptoms or ask a health question..." 
                    rows="1"
                    disabled
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                    <span class="material-symbols-rounded">send</span>
                </button>
            </div>
            <div class="mt-2 text-center">
                <span class="text-[10px] text-slate-400 mono uppercase tracking-wider">Bophelo Bot is not a substitute for professional medical advice, diagnosis, or treatment.</span>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="auth-modal">
            <div class="brand-icon">
                <span class="material-symbols-rounded" style="font-size: 32px;">local_hospital</span>
            </div>
            <h2>Sign in to Bophelo Bot</h2>
            <p>Securely access your health consultations and history</p>
            <button class="google-btn" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            projectId: "fire-b-a8878",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const remoteConfig = firebase.remoteConfig();
        
        // xAI Configuration
        let XAI_API_KEY = "";
        const MODEL_ID = "grok-4-1-fast-reasoning";
        
        let currentUser = null;
        let isProcessing = false;
        let conversationHistory = [];
        let currentLanguage = 'en';
        
        // South African Emergency Numbers
        const SA_EMERGENCY = {
            ambulance: '10177',
            netcare: '082 911',
            er24: '084 124',
            poison: '0861 555 777'
        };
        
        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            remoteConfig.settings = { minimumFetchIntervalMillis: 0 };
            try {
                await remoteConfig.fetchAndActivate();
                XAI_API_KEY = remoteConfig.getValue('xai_api_key').asString();
                console.log('xAI API Key loaded');
            } catch (error) {
                console.error('Remote Config error:', error);
                XAI_API_KEY = "your-xai-api-key-here";
            }
        }
        
        // ==================== AUTHENTICATION ====================
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUI(user);
            
            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (user) {
                input.disabled = false;
                sendBtn.disabled = false;
            } else {
                input.disabled = true;
                sendBtn.disabled = true;
            }
        });
        
        function updateUI(user) {
            const userBtn = document.getElementById('userBtn');
            if (user) {
                userBtn.innerHTML = `<span class="font-bold text-emerald-600">${user.displayName?.[0] || 'U'}</span>`;
                document.getElementById('authModal').classList.remove('active');
            } else {
                userBtn.innerHTML = `<span class="material-symbols-rounded text-slate-600">person</span>`;
            }
        }
        
        function toggleAuth() {
            if (!currentUser) {
                document.getElementById('authModal').classList.add('active');
            } else {
                if (confirm('Sign out of Bophelo Bot?')) {
                    auth.signOut();
                    conversationHistory = [];
                    resetChat();
                }
            }
        }
        
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error('Auth error:', error);
                alert('Sign in failed. Please try again.');
            });
        }
        
        // ==================== LANGUAGE SUPPORT ====================
        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const placeholders = {
                en: "Describe your symptoms or ask a health question...",
                zu: "Chaza izimpawu zakho noma ubuze umbuzo wezempilo...",
                af: "Beskryf jou simptome of vra 'n gesondheidsvraag..."
            };
            
            document.getElementById('userInput').placeholder = placeholders[lang];
        }
        
        // ==================== CHAT FUNCTIONS ====================
        function setInput(text) {
            if (!currentUser) {
                toggleAuth();
                return;
            }
            const input = document.getElementById('userInput');
            input.value = text;
            input.focus();
            autoResize(input);
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        function resetChat() {
            conversationHistory = [];
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = `
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">
                        <span class="material-symbols-rounded" style="font-size: 48px;">stethoscope</span>
                    </div>
                    <h2>Your Personal Health Assistant</h2>
                    <p>Describe your symptoms or health concerns in English, isiZulu, or Afrikaans. I'll provide general health information tailored for South Africa.</p>
                    
                    <div class="suggestions">
                        <div class="suggestion-card" onclick="setInput('I have a headache and fever, what could it be?')">
                            <h4>
                                <span class="material-symbols-rounded suggestion-icon" style="font-size: 20px;">sick</span>
                                Symptom Checker
                            </h4>
                            <p>Headache, fever, flu symptoms</p>
                        </div>
                        <div class="suggestion-card" onclick="setInput('What are the warning signs of a heart attack?')">
                            <h4>
                                <span class="material-symbols-rounded suggestion-icon" style="font-size: 20px;">cardiology</span>
                                Emergency Signs
                            </h4>
                            <p>When to call 10177 immediately</p>
                        </div>
                        <div class="suggestion-card" onclick="setInput('How do I manage high blood pressure?')">
                            <h4>
                                <span class="material-symbols-rounded suggestion-icon" style="font-size: 20px;">monitor_heart</span>
                                Chronic Conditions
                            </h4>
                            <p>Hypertension, diabetes, HIV management</p>
                        </div>
                        <div class="suggestion-card" onclick="setInput('Where can I get ARVs near me?')">
                            <h4>
                                <span class="material-symbols-rounded suggestion-icon" style="font-size: 20px;">local_hospital</span>
                                Local Healthcare
                            </h4>
                            <p>Clinics, hospitals, medication access</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex items-center gap-2 text-xs text-slate-400 mono">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        Neural Core v4.0.2 • xAI Powered
                    </div>
                </div>
            `;
            document.getElementById('userInput').value = '';
        }
        
        async function sendMessage() {
            if (isProcessing || !currentUser) return;
            
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            isProcessing = true;
            input.value = '';
            autoResize(input);
            
            // Remove welcome screen
            const welcome = document.getElementById('welcomeScreen');
            if (welcome) welcome.remove();
            
            // Check for emergency keywords (English, Zulu, Afrikaans)
            const emergencyKeywords = [
                'chest pain', 'heart attack', 'stroke', 'can\'t breathe', 'not breathing', 
                'unconscious', 'severe bleeding', 'suicide', 'kill myself', 'choking',
                'isifuba', 'ngingafa', 'struggling to breathe', 'heart attack', 'hartaanval',
                'breyting', 'bewusteloos', 'ernstige bloeding'
            ];
            
            const isEmergency = emergencyKeywords.some(keyword => 
                message.toLowerCase().includes(keyword)
            );
            
            // Add user message
            addMessage('user', message);
            
            if (isEmergency) {
                const emergencyHTML = `
                    <div class="critical-alert">
                        <h3>
                            <span class="material-symbols-rounded">emergency</span>
                            MEDICAL EMERGENCY DETECTED
                        </h3>
                        <p><strong>Call emergency services immediately:</strong></p>
                        <p>• <strong>Netcare 911:</strong> ${SA_EMERGENCY.netcare}<br>
                        • <strong>ER24:</strong> ${SA_EMERGENCY.er24}<br>
                        • <strong>Ambulance:</strong> ${SA_EMERGENCY.ambulance}</p>
                        <p class="mt-2">Do not wait for AI assistance. If you cannot call, ask someone nearby to call for you. Your life may be at risk.</p>
                    </div>
                `;
                addMessage('ai', emergencyHTML);
                isProcessing = false;
                return;
            }
            
            // Show typing
            const typingId = showTyping();
            
            try {
                const response = await fetchXAIResponse(message);
                removeTyping(typingId);
                addMessage('ai', response);
                
                conversationHistory.push({ role: 'user', content: message });
                conversationHistory.push({ role: 'assistant', content: response });
                
            } catch (error) {
                removeTyping(typingId);
                addMessage('ai', 'I apologize, but I encountered an error. Please try again or contact your healthcare provider directly.');
                console.error('xAI Error:', error);
            }
            
            isProcessing = false;
        }
        
        async function fetchXAIResponse(message) {
            const systemPrompt = `You are Bophelo Bot, a helpful medical information assistant for South Africa. 

CRITICAL GUIDELINES:
1. Always include a disclaimer that you are an AI, not a doctor
2. For serious symptoms, urge users to seek professional medical care immediately
3. Never provide definitive diagnoses - only general health information
4. Be empathetic, clear, and culturally sensitive to South African context
5. Reference local resources where appropriate (public clinics, Netcare, ER24, HIV testing sites)
6. If unsure, recommend consulting a healthcare provider at a local clinic or hospital
7. Never prescribe medications or specific dosages
8. Support multiple South African languages and contexts
9. Always prioritize safety over completeness

Emergency numbers in South Africa:
- Netcare 911: 082 911
- ER24: 084 124  
- Ambulance: 10177
- Poison Control: 0861 555 777

Current date: ${new Date().toISOString().split('T')[0]}`;
            
            const messages = [
                { role: "system", content: systemPrompt },
                ...conversationHistory.slice(-10).map(msg => ({
                    role: msg.role === 'assistant' ? 'assistant' : 'user',
                    content: msg.content
                })),
                { role: "user", content: message }
            ];
            
            const response = await fetch("https://api.x.ai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${XAI_API_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: MODEL_ID,
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 800,
                    stream: false
                })
            });
            
            if (!response.ok) throw new Error('API request failed');
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        function addMessage(role, content) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const time = new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
            
            const isHTML = content.includes('<div');
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${role === 'ai' ? 'BB' : currentUser?.displayName?.[0] || 'U'}
                </div>
                <div class="message-content">
                    <div class="message-bubble ${isHTML ? '' : ''}">${isHTML ? content : formatContent(content)}</div>
                    <div class="message-meta">
                        ${role === 'ai' ? '<span class="material-symbols-rounded" style="font-size: 12px;">verified</span> Bophelo Bot • ' : ''}
                        ${time}
                    </div>
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        function formatContent(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }
        
        function showTyping() {
            const messagesArea = document.getElementById('messagesArea');
            const id = 'typing-' + Date.now();
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = id;
            typingDiv.innerHTML = `
                <div class="message-avatar">BB</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            messagesArea.appendChild(typingDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            return id;
        }
        
        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
        
        // ==================== EVENT LISTENERS ====================
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('userInput').addEventListener('input', function() {
            autoResize(this);
        });
        
        // Initialize
        initializeApp();
    </script>
</body>
</html>
